// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Member {
  id                    String    @id @default(uuid())
  memberId              String    @unique
  email                 String    @unique
  primaryWallet         String
  evmWallet             String
  kycStatus             KYCStatus
  jurisdiction          Int
  flags                 BigInt
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  handle                String    @unique // Human-readable handle (e.g., founder.fth)
  membershipTier        String    // BRONZE, SILVER, GOLD, ELITE, PLATINUM
  membershipNftId       String?   @unique // XRPL NFT Token ID
  usdfBalance           Decimal   @default(0) @db.Decimal(10, 2) // USDF rewards credits
  fthusdBalance         Decimal   @default(0) @db.Decimal(10, 2) // FTHUSD balance cache
  lastRewardsAccrual    DateTime? // Last time USDF rewards were calculated
  accountCreatedAt      DateTime  @default(now()) // For tenure calculation
  usBankAccountLinked   Boolean   @default(false) // US bank account verified
  usBankAccountId       String?   // External bank account reference
}

// Membership NFT metadata on XRPL
model MembershipNFT {
  id               String   @id @default(uuid())
  memberId         String   @unique
  nftTokenId       String   @unique // XRPL NFT Token ID
  handle           String   @unique // founder.fth
  tier             String   // ELITE, PLATINUM, etc.
  xrplAddress      String   // Owner XRPL address
  mintedAt         DateTime @default(now())
  metadata         Json?    // Additional NFT metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
}

model LedgerTransaction {
  id                String    @id @default(uuid())
  memberId          String
  type              String    // BANK_DEPOSIT_ACH, BANK_DEPOSIT_WIRE, WITHDRAWAL_US_BANK, TRANSFER_INTERNAL, GOLD_PURCHASE, REWARD_ACCRUAL_USDF, etc.
  amount            Decimal   @db.Decimal(10, 2)
  currency          String    // FTHUSD, USDF
  status            String    // PENDING, COMPLETED, FAILED, CANCELLED
  fee               Decimal?  @db.Decimal(10, 2)
  netAmount         Decimal?  @db.Decimal(10, 2)
  relatedOrderId    String?   // Link to GoldOrder or other entity
  bankAccountId     String?   // US bank account used
  xrplTxHash        String?   // XRPL transaction hash if applicable
  description       String?   // Human-readable description
  metadata          Json?     @db.JsonB // Changed to JsonB for better compatibility
  timestamp         DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([memberId, timestamp])
  @@index([type, status])
}

model GoldOrder {
  id                String    @id @default(uuid())
  memberId          String
  metalType         String    // GOLD, SILVER, PLATINUM, PALLADIUM
  ounces            Decimal   @db.Decimal(10, 4)
  pricePerOunce     Decimal   @db.Decimal(10, 2)
  price             Decimal   @db.Decimal(10, 2) // Changed from totalPrice to price
  discountApplied   Decimal?  @db.Decimal(5, 2) // Percentage discount (e.g., 12.00 for 12%)
  usdfUsed          Decimal?  @db.Decimal(10, 2) // USDF credits applied
  status            String    // PENDING, CONFIRMED, FULFILLED, CANCELLED, FAILED
  fulfillmentDate   DateTime?
  trackingNumber    String?
  nftCertificateId  String?   // XRPL NFT for ownership certificate
  metadata          Json?     @db.JsonB // Changed to JsonB for better compatibility
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([memberId, status])
  @@index([createdAt])
}

// US Bank Account Links (US-only for now)
model USBankAccount {
  id                String   @id @default(uuid())
  memberId          String
  accountNumber     String   // Encrypted/hashed
  routingNumber     String
  accountType       String   // CHECKING, SAVINGS
  bankName          String
  accountHolderName String
  verified          Boolean  @default(false)
  verifiedAt        DateTime?
  isPrimary         Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([memberId])
}

// Proof of Reserves Snapshots
model PorSnapshot {
  id                String   @id @default(uuid())
  totalIssued       Decimal  @db.Decimal(18, 2) // Total FTHUSD issued
  totalBacking      Decimal  @db.Decimal(18, 2) // Total USD backing
  coverageRatio     Decimal  @db.Decimal(6, 4)  // e.g., 1.0480 = 104.8%
  snapshotTime      DateTime @default(now())
  merkleRoot        String?  // For member verification
  anchored          Boolean  @default(false) // Anchored to EVM
  evmTxHash         String?  // EVM transaction hash
  metadata          Json?
  createdAt         DateTime @default(now())

  @@index([snapshotTime])
}
